<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Post-Quantum Cryptography Benchmark</title>
  <script type="module">
    import falcon from 'https://cdn.jsdelivr.net/npm/falcon-crypto@1.0.6/+esm';
    import dilithiumCrystals from 'https://cdn.jsdelivr.net/npm/dilithium-crystals@1.0.6/+esm';
    import sphincs from 'https://cdn.jsdelivr.net/npm/sphincs@3.0.4/+esm'

    const ITERATIONS = 30000;

    const benchmarkResults = {
      "Falcon": {},
      "Dilithium": {},
      "SPHINCS": {}
    };

    function convertMsToSeconds(ms) {
      return (ms / 1000).toFixed(3) + " sec";
    }

    function formatBytes(bytes) {
      return { value: bytes, unit: "B" };
    }

    async function measureTime(fn, iterations) {
      const start = performance.now();
      for (let i = 0; i < iterations; i++) await fn();
      const end = performance.now();
      const timeTakenMs = (end - start).toFixed(3);
      return {
        value: parseFloat(timeTakenMs),
        unit: "ms",
        converted: convertMsToSeconds(timeTakenMs)
      };
    }

    async function benchmarkFalcon() {
      console.log("[-] Benchmarking Falcon...");

      // Measure key generation time
      const keyGenTime = await measureTime(() => falcon.keyPair(), ITERATIONS);
      const keyPair = await falcon.keyPair();
      const message = new Uint8Array([104, 101, 108, 108, 111, 0]); // "hello"

      // Measure time for signing and verification
      const signTime = await measureTime(() => falcon.sign(message, keyPair.privateKey), ITERATIONS);
      const signed = await falcon.sign(message, keyPair.privateKey);

      const openTime = await measureTime(() => falcon.open(signed, keyPair.publicKey), ITERATIONS);
      const verified = await falcon.open(signed, keyPair.publicKey);

      // Measure time for detached signature and verification
      const signDetachedTime = await measureTime(() => falcon.signDetached(message, keyPair.privateKey), ITERATIONS);
      const signature = await falcon.signDetached(message, keyPair.privateKey);

      const verifyDetachedTime = await measureTime(() => falcon.verifyDetached(signature, message, keyPair.publicKey), ITERATIONS);
      const isValid = await falcon.verifyDetached(signature, message, keyPair.publicKey);

      benchmarkResults.Falcon = {
        keyGenTime,
        signTime,
        openTime,
        signDetachedTime,
        verifyDetachedTime,
        signatureSize: formatBytes(signature.length),
        signedSize: formatBytes(signed.length),
        verifiedSize: formatBytes(verified.length),
        isValid
      };
    }

    async function benchmarkDilithium() {
      console.log("[-] Benchmarking Dilithium...");

      // Measure key generation time
      const keyGenTime = await measureTime(() => dilithiumCrystals.keyPair(), ITERATIONS);
      const keyPair = await dilithiumCrystals.keyPair();
      const message = new Uint8Array([104, 101, 108, 108, 111, 0]); // "hello"

      // Measure time for signing and verification
      const signTime = await measureTime(() => dilithiumCrystals.sign(message, keyPair.privateKey), ITERATIONS);
      const signed = await dilithiumCrystals.sign(message, keyPair.privateKey);

      const openTime = await measureTime(() => dilithiumCrystals.open(signed, keyPair.publicKey), ITERATIONS);
      const verified = await dilithiumCrystals.open(signed, keyPair.publicKey);

      // Measure time for detached signature and verification
      const signDetachedTime = await measureTime(() => dilithiumCrystals.signDetached(message, keyPair.privateKey), ITERATIONS);
      const signature = await dilithiumCrystals.signDetached(message, keyPair.privateKey);

      const verifyDetachedTime = await measureTime(() => dilithiumCrystals.verifyDetached(signature, message, keyPair.publicKey), ITERATIONS);
      const isValid = await dilithiumCrystals.verifyDetached(signature, message, keyPair.publicKey);

      benchmarkResults.Dilithium = {
        keyGenTime,
        signTime,
        openTime,
        signDetachedTime,
        verifyDetachedTime,
        signatureSize: formatBytes(signature.length),
        signedSize: formatBytes(signed.length),
        verifiedSize: formatBytes(verified.length),
        isValid
      };
    }

    /*
    async function benchmarkSphincs() {
      console.log("[-] Benchmarking SPHINCS+...");

      // Measure key generation time
      const keyGenTime = await measureTime(() => sphincs.keyPair(), ITERATIONS);
      const keyPair = await sphincs.keyPair();
      const message = new Uint8Array([104, 101, 108, 108, 111, 0]); // "hello"

      // Measure time for signing and verification
      const signTime = await measureTime(() => sphincs.sign(message, keyPair.privateKey), ITERATIONS);
      const signed = await sphincs.sign(message, keyPair.privateKey);

      const openTime = await measureTime(() => sphincs.open(signed, keyPair.publicKey), ITERATIONS);
      const verified = await sphincs.open(signed, keyPair.publicKey);

      // Measure time for detached signature and verification
      const signDetachedTime = await measureTime(() => sphincs.signDetached(message, keyPair.privateKey), ITERATIONS);
      const signature = await sphincs.signDetached(message, keyPair.privateKey);

      const verifyDetachedTime = await measureTime(() => sphincs.verifyDetached(signature, message, keyPair.publicKey), ITERATIONS);
      const isValid = await sphincs.verifyDetached(signature, message, keyPair.publicKey);

      benchmarkResults.SPHINCS = {
        keyGenTime,
        signTime,
        openTime,
        signDetachedTime,
        verifyDetachedTime,
        signatureSize: formatBytes(signature.length),
        signedSize: formatBytes(signed.length),
        verifiedSize: formatBytes(verified.length),
        isValid
      };
    } */

    async function runBenchmark() {
      console.log("[x] Running Post-Quantum Cryptography Benchmark in Browser...");

      await benchmarkFalcon();
      await benchmarkDilithium();
      //await benchmarkSphincs();

      console.log("[x] Benchmark completed!");

      document.getElementById("downloadBtn").style.display = "block";
      document.getElementById("downloadBtn").onclick = function () {
        const blob = new Blob([JSON.stringify(benchmarkResults, null, 4)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "browser_pqc_benchmark.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      };
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("startBtn").onclick = runBenchmark;
    });
  </script>
</head>
<body>
<h2>Post-Quantum Cryptography Benchmark</h2>
<button id="startBtn">Start Benchmark</button>
<button id="downloadBtn" style="display: none;">Download Results</button>
</body>
</html>
